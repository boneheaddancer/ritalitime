<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RitaliTime - Medication Timeline Simulator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .dose-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f8f9fa;
        }
        .timeline-container {
            height: 400px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            background-color: white;
        }
        .form-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <h1 class="text-center mb-4">üíä RitaliTime - Medication Timeline Simulator</h1>
        
        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="main-tab" data-bs-toggle="tab" data-bs-target="#main-content" type="button" role="tab">
                    üè† Main
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings-content" type="button" role="tab">
                    ‚öôÔ∏è Settings
                </button>
            </li>
        </ul>
        
        <!-- Tab Content -->
        <div class="tab-content" id="mainTabsContent">
            <!-- Main Tab -->
            <div class="tab-pane fade show active" id="main-content" role="tabpanel">
                <div class="row">
                    <!-- Left Column - Forms -->
                    <div class="col-md-4">
                        <!-- Medication Form -->
                        <div class="form-section">
                            <h4>üíä Add Medication</h4>
                            <form id="medicationForm">
                                <div class="mb-3">
                                    <label for="medTime" class="form-label">Time</label>
                                    <input type="time" class="form-control" id="medTime" value="08:00" required>
                                </div>
                                <div class="mb-3">
                                    <label for="medName" class="form-label">Medication</label>
                                    <select class="form-select" id="medName" required>
                                        <option value="">Select medication...</option>
                                        {% for category, stims in medications_data.get('stimulants', {}).items() %}
                                            {% for stim_name, stim_data in stims.items() %}
                                                <option value="{{ stim_name }}">{{ stim_data.display_name }}</option>
                                            {% endfor %}
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="medDosage" class="form-label">Dosage (mg)</label>
                                    <input type="number" class="form-control" id="medDosage" min="0.1" step="0.1" value="1" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Add Medication</button>
                            </form>
                        </div>

                        <!-- Stimulant Form -->
                        <div class="form-section">
                            <h4>‚ö° Add Stimulant</h4>
                            <form id="stimulantForm">
                                <div class="mb-3">
                                    <label for="stimTime" class="form-label">Time</label>
                                    <input type="time" class="form-control" id="stimTime" value="08:00" required>
                                </div>
                                <div class="mb-3">
                                    <label for="stimName" class="form-label">Stimulant</label>
                                    <select class="form-select" id="stimName" required>
                                        <option value="">Select stimulant...</option>
                                        {% for category, stims in medications_data.get('stimulants', {}).items() %}
                                            {% for stim_name, stim_data in stims.items() %}
                                                <option value="{{ stim_name }}">{{ stim_data.display_name }}</option>
                                            {% endfor %}
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="stimQuantity" class="form-label">Quantity</label>
                                    <input type="number" class="form-control" id="stimQuantity" min="1" value="1" required>
                                </div>
                                <button type="submit" class="btn btn-warning">Add Stimulant</button>
                            </form>
                        </div>

                        <!-- Painkiller Form -->
                        <div class="form-section">
                            <h4>ü©π Add Painkiller</h4>
                            <form id="painkillerForm">
                                <div class="mb-3">
                                    <label for="pkTime" class="form-label">Time</label>
                                    <input type="time" class="form-control" id="pkTime" value="08:00" required>
                                </div>
                                <div class="mb-3">
                                    <label for="pkName" class="form-label">Painkiller</label>
                                    <select class="form-select" id="pkName" required>
                                        <option value="">Select painkiller...</option>
                                        {% for pk_name, pk_data in medications_data.get('painkillers', {}).items() %}
                                            <option value="{{ pk_name }}">{{ pk_data.display_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="pkPills" class="form-label">Pills</label>
                                    <input type="number" class="form-control" id="pkPills" min="1" max="4" value="1" required>
                                </div>
                                <button type="submit" class="btn btn-danger">Add Painkiller</button>
                            </form>
                        </div>
                    </div>

                    <!-- Right Column - Timeline and Doses -->
                    <div class="col-md-8">
                        <!-- Timeline Graph -->
                        <div class="timeline-container">
                            <h4>üìä Daily Timeline</h4>
                            <canvas id="timelinePlot"></canvas>
                        </div>

                        <!-- Current Doses -->
                        <div class="row mt-4">
                            <div class="col-md-4">
                                <h5>üíä Medications</h5>
                                <div id="medicationsList"></div>
                                <button class="btn btn-sm btn-outline-danger" onclick="clearAll('medications')">Clear All</button>
                            </div>
                            <div class="col-md-4">
                                <h5>‚ö° Stimulants</h5>
                                <div id="stimulantsList"></div>
                                <button class="btn btn-sm btn-outline-danger" onclick="clearAll('stimulants')">Clear All</button>
                            </div>
                            <div class="col-md-4">
                                <h5>ü©π Painkillers</h5>
                                <div id="painkillersList"></div>
                                <button class="btn btn-sm btn-outline-danger" onclick="clearAll('painkillers')">Clear All</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Settings Tab -->
            <div class="tab-pane fade" id="settings-content" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <!-- Profile Settings -->
                        <div class="form-section">
                            <h4>üë§ Profile Settings</h4>
                            <div class="mb-3">
                                <label for="profileSelect" class="form-label">Current Profile</label>
                                <select class="form-select" id="profileSelect">
                                    <option value="">Select profile...</option>
                                    {% for profile_name, profile_data in profiles_data.items() %}
                                        <option value="{{ profile_name }}">{{ profile_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="sleepThreshold" class="form-label">Sleep Threshold</label>
                                <input type="range" class="form-range" id="sleepThreshold" min="0" max="1" step="0.1" value="0.3">
                                <small class="text-muted">Current: <span id="sleepThresholdValue">0.3</span></small>
                            </div>
                            <button class="btn btn-secondary" onclick="saveSettings()">Save Profile Settings</button>
                        </div>
                        
                        <!-- Data Management -->
                        <div class="form-section">
                            <h4>üíæ Data Management</h4>
                            <div class="mb-3">
                                <button class="btn btn-success me-2" onclick="exportData()">Export Data</button>
                                <button class="btn btn-info me-2" onclick="importData()">Import Data</button>
                                <button class="btn btn-warning" onclick="clearAllData()">Clear All Data</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <!-- Medication Selection -->
                        <div class="form-section">
                            <h4>üíä Medication Selection</h4>
                            <p class="text-muted">Select which medications you'd like to have available:</p>
                            
                            <div class="mb-3">
                                <h6 class="text-primary">Prescription Stimulants</h6>
                                <div id="prescriptionStimulants">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <h6 class="text-success">Common Stimulants</h6>
                                <div id="commonStimulants">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <h6 class="text-warning">Painkillers</h6>
                                <div id="painkillers">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                            
                            <button class="btn btn-primary w-100" onclick="saveMedicationSelection()">Save Medication Selection</button>
                        </div>
                        
                        <!-- User Preferences -->
                        <div class="form-section">
                            <h4>‚öôÔ∏è User Preferences</h4>
                            <div class="mb-3">
                                <label for="defaultMedTime" class="form-label">Default Dose Time (ADHD Medications)</label>
                                <input type="time" class="form-control" id="defaultMedTime" value="08:00">
                            </div>
                            <div class="mb-3">
                                <label for="defaultStimTime" class="form-label">Default Dose Time (Stimulants)</label>
                                <input type="time" class="form-control" id="defaultStimTime" value="09:00">
                            </div>
                            <div class="mb-3">
                                <label for="defaultPkTime" class="form-label">Default Dose Time (Painkillers)</label>
                                <input type="time" class="form-control" id="defaultPkTime" value="08:00">
                            </div>
                            <div class="mb-3">
                                <label for="defaultPills" class="form-label">Default Pill Count (Painkillers)</label>
                                <input type="number" class="form-control" id="defaultPills" min="1" max="10" value="1">
                            </div>
                            <button class="btn btn-success w-100" onclick="savePreferences()">Save Preferences</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Make medications data available to JavaScript
        window.medicationsData = {{ medications_data | tojson | safe }};
        
        // Form submissions
        document.getElementById('medicationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            addDose('medication');
        });

        document.getElementById('stimulantForm').addEventListener('submit', function(e) {
            e.preventDefault();
            addDose('stimulant');
        });

        document.getElementById('painkillerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            addDose('painkiller');
        });

        function addDose(type) {
            let formData = {};
            
            if (type === 'medication') {
                formData = {
                    time: document.getElementById('medTime').value,
                    name: document.getElementById('medName').value,
                    dosage: parseFloat(document.getElementById('medDosage').value)
                };
            } else if (type === 'stimulant') {
                formData = {
                    time: document.getElementById('stimTime').value,
                    name: document.getElementById('stimName').value,
                    quantity: parseInt(document.getElementById('stimQuantity').value)
                };
            } else if (type === 'painkiller') {
                formData = {
                    time: document.getElementById('pkTime').value,
                    name: document.getElementById('pkName').value,
                    pills: parseInt(document.getElementById('pkPills').value)
                };
            }

            fetch(`/api/add_${type}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateDosesList();
                    updateTimeline();
                    // Reset form
                    document.getElementById(`${type}Form`).reset();
                    
                    // Reset time field based on type
                    let timeFieldId;
                    if (type === 'medication') timeFieldId = 'medTime';
                    else if (type === 'stimulant') timeFieldId = 'stimTime';
                    else if (type === 'painkiller') timeFieldId = 'pkTime';
                    
                    if (timeFieldId) {
                        const timeField = document.getElementById(timeFieldId);
                        if (timeField) timeField.value = '08:00';
                    }
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function updateDosesList() {
            fetch('/api/get_doses')
            .then(response => response.json())
            .then(data => {
                displayDoses('medicationsList', data.medications, 'medication');
                displayDoses('stimulantsList', data.stimulants, 'stimulant');
                displayDoses('painkillersList', data.painkillers, 'painkiller');
            });
        }

        function displayDoses(containerId, doses, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            doses.forEach(dose => {
                const doseCard = document.createElement('div');
                doseCard.className = 'dose-card';
                
                let timeStr = formatTime(dose.time_hours);
                let details = '';
                
                if (type === 'medication') {
                    details = `${dose.dosage}mg at ${timeStr}`;
                } else if (type === 'stimulant') {
                    details = `${dose.quantity} at ${timeStr}`;
                } else if (type === 'painkiller') {
                    details = `${dose.pills} pill(s) at ${timeStr}`;
                }
                
                doseCard.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <span>${dose.name}</span>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeDose(${dose.id})">√ó</button>
                    </div>
                    <small class="text-muted">${details}</small>
                `;
                
                container.appendChild(doseCard);
            });
        }

        function formatTime(hours) {
            const hour = Math.floor(hours);
            const minute = Math.round((hours - hour) * 60);
            return `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
        }

        function removeDose(id) {
            fetch('/api/remove_dose', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({id: id})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateDosesList();
                    updateTimeline();
                }
            });
        }

        function clearAll(type) {
            fetch('/api/clear_all', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({type: type})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateDosesList();
                    updateTimeline();
                }
            });
        }

        let timelineChart = null;

        function updateTimeline() {
            fetch('/api/get_doses')
            .then(response => response.json())
            .then(data => {
                // Create timeline data
                const timePoints = Array.from({length: 241}, (_, i) => i / 10); // 0 to 24 hours in 0.1 hour steps
                
                // Generate datasets for each dose type
                const datasets = [];
                
                // Add medication effects
                data.medications.forEach(dose => {
                    const dataset = generateEffectDataset(timePoints, dose, 'medication');
                    if (dataset) datasets.push(dataset);
                });
                
                // Add stimulant effects
                data.stimulants.forEach(dose => {
                    const dataset = generateEffectDataset(timePoints, dose, 'stimulant');
                    if (dataset) datasets.push(dataset);
                });
                
                // Add painkiller effects
                data.painkillers.forEach(dose => {
                    const dataset = generateEffectDataset(timePoints, dose, 'painkiller');
                    if (dataset) datasets.push(dataset);
                });
                
                // Destroy existing chart if it exists
                if (timelineChart) {
                    timelineChart.destroy();
                }
                
                // Create new chart
                const ctx = document.getElementById('timelinePlot').getContext('2d');
                timelineChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: timePoints.map(t => `${Math.floor(t)}:${Math.round((t % 1) * 60).toString().padStart(2, '0')}`),
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Daily Effect Timeline'
                            },
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Time (hours)'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Effect Level'
                                },
                                beginAtZero: true
                            }
                        }
                    }
                });
            });
        }

        function generateEffectDataset(timePoints, dose, type) {
            // Generate effect data for Chart.js
            const effect = [];
            const doseTime = dose.time_hours;
            
            for (let t of timePoints) {
                let timeDiff = t - doseTime;
                
                // Handle midnight crossing
                if (timeDiff < -12) timeDiff += 24;
                if (timeDiff > 12) timeDiff -= 24;
                
                if (timeDiff >= 0 && timeDiff < 8) {
                    let level = 0;
                    if (timeDiff < 1) {
                        level = timeDiff; // Ramp up
                    } else if (timeDiff < 5) {
                        level = 1; // Peak
                    } else {
                        level = 1 - (timeDiff - 5) / 3; // Decline
                    }
                    
                    // Scale by dose amount
                    if (type === 'medication') {
                        level *= dose.dosage / 20; // Normalize to 20mg
                    } else if (type === 'stimulant') {
                        level *= dose.quantity;
                    } else if (type === 'painkiller') {
                        level *= dose.pills;
                    }
                    
                    effect.push(Math.max(0, level));
                } else {
                    effect.push(0);
                }
            }
            
            // Generate random color for each dataset
            const colors = [
                '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', 
                '#DDA0DD', '#98D8C8', '#F7DC6F', '#FF7675', '#74B9FF'
            ];
            const colorIndex = Math.floor(Math.random() * colors.length);
            
            return {
                label: `${dose.name} (${formatTime(dose.time_hours)})`,
                data: effect,
                borderColor: colors[colorIndex],
                backgroundColor: colors[colorIndex] + '20',
                borderWidth: 2,
                fill: false,
                tension: 0.1,
                pointRadius: 0,
                pointHoverRadius: 4
            };
        }

        // Settings functions
        function loadSettings() {
            fetch('/api/settings')
            .then(response => response.json())
            .then(data => {
                if (data && Object.keys(data).length > 0) {
                    // Load first profile by default
                    const firstProfile = Object.keys(data)[0];
                    
                    // Populate profile dropdown
                    const profileSelect = document.getElementById('profileSelect');
                    if (profileSelect) {
                        profileSelect.innerHTML = '';
                        
                        Object.keys(data).forEach(profileKey => {
                            const profile = data[profileKey];
                            const option = document.createElement('option');
                            option.value = profileKey;
                            option.textContent = profile.name || profileKey;
                            profileSelect.appendChild(option);
                        });
                        
                        profileSelect.value = firstProfile;
                        loadProfile(firstProfile);
                    }
                }
            })
            .catch(error => {
                console.error('Error loading settings:', error);
            });
            
            // Load medication selection
            loadMedicationSelection();
        }
        
        function loadMedicationSelection() {
            // Load medications data from the main page data
            const medicationsData = window.medicationsData || {};
            
            // Populate prescription stimulants
            const prescriptionStimulants = document.getElementById('prescriptionStimulants');
            if (prescriptionStimulants && medicationsData.stimulants && medicationsData.stimulants.prescription_stimulants) {
                prescriptionStimulants.innerHTML = '';
                Object.entries(medicationsData.stimulants.prescription_stimulants).forEach(([key, data]) => {
                    const div = document.createElement('div');
                    div.className = 'form-check mb-2';
                    div.innerHTML = `
                        <input class="form-check-input" type="checkbox" id="med-check-${key}" checked>
                        <label class="form-check-label" for="med-check-${key}">
                            ${data.display_name || key}
                        </label>
                    `;
                    prescriptionStimulants.appendChild(div);
                });
            }
            
            // Populate common stimulants
            const commonStimulants = document.getElementById('commonStimulants');
            if (commonStimulants && medicationsData.stimulants && medicationsData.stimulants.common_stimulants) {
                commonStimulants.innerHTML = '';
                Object.entries(medicationsData.stimulants.common_stimulants).forEach(([key, data]) => {
                    const div = document.createElement('div');
                    div.className = 'form-check mb-2';
                    div.innerHTML = `
                        <input class="form-check-input" type="checkbox" id="stim-check-${key}" checked>
                        <label class="form-check-label" for="stim-check-${key}">
                            ${data.display_name || key}
                        </label>
                    `;
                    commonStimulants.appendChild(div);
                });
            }
            
            // Populate painkillers
            const painkillers = document.getElementById('painkillers');
            if (painkillers && medicationsData.painkillers) {
                painkillers.innerHTML = '';
                Object.entries(medicationsData.painkillers).forEach(([key, data]) => {
                    const div = document.createElement('div');
                    div.className = 'form-check mb-2';
                    div.innerHTML = `
                        <input class="form-check-input" type="checkbox" id="pk-check-${key}" checked>
                        <label class="form-check-label" for="pk-check-${key}">
                            ${data.display_name || key}
                        </label>
                    `;
                    painkillers.appendChild(div);
                });
            }
        }
        
        function saveMedicationSelection() {
            // Collect all checkbox states
            const selection = {};
            
            // Get prescription stimulants
            const prescriptionChecks = document.querySelectorAll('#prescriptionStimulants input[type="checkbox"]');
            prescriptionChecks.forEach(check => {
                const key = check.id.replace('med-check-', '');
                selection[key] = check.checked;
            });
            
            // Get common stimulants
            const commonChecks = document.querySelectorAll('#commonStimulants input[type="checkbox"]');
            commonChecks.forEach(check => {
                const key = check.id.replace('stim-check-', '');
                selection[key] = check.checked;
            });
            
            // Get painkillers
            const pkChecks = document.querySelectorAll('#painkillers input[type="checkbox"]');
            pkChecks.forEach(check => {
                const key = check.id.replace('pk-check-', '');
                selection[key] = check.checked;
            });
            
            console.log('Saving medication selection:', selection);
            // Here you would typically save to localStorage or send to server
            localStorage.setItem('medicationSelection', JSON.stringify(selection));
            alert('Medication selection saved!');
        }
        
        function savePreferences() {
            const preferences = {
                defaultMedTime: document.getElementById('defaultMedTime').value,
                defaultStimTime: document.getElementById('defaultStimTime').value,
                defaultPkTime: document.getElementById('defaultPkTime').value,
                defaultPills: parseInt(document.getElementById('defaultPills').value)
            };
            
            console.log('Saving preferences:', preferences);
            localStorage.setItem('userPreferences', JSON.stringify(preferences));
            alert('Preferences saved!');
        }

        function loadProfile(profileName) {
            fetch('/api/settings')
            .then(response => response.json())
            .then(data => {
                if (data[profileName]) {
                    const profile = data[profileName];
                    
                    // Load sleep threshold
                    if (profile.sleep_threshold !== undefined) {
                        const sleepThresholdEl = document.getElementById('sleepThreshold');
                        const sleepThresholdValueEl = document.getElementById('sleepThresholdValue');
                        if (sleepThresholdEl) {
                            sleepThresholdEl.value = profile.sleep_threshold;
                        }
                        if (sleepThresholdValueEl) {
                            sleepThresholdValueEl.textContent = profile.sleep_threshold;
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Error loading profile:', error);
            });
        }

        function saveSettings() {
            const profileName = document.getElementById('profileSelect').value;
            const sleepThreshold = parseFloat(document.getElementById('sleepThreshold').value);
            
            if (!profileName) {
                alert('Please select a profile first');
                return;
            }
            
            const settings = {
                [profileName]: {
                    sleep_threshold: sleepThreshold
                }
            };
            
            fetch('/api/settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(settings)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Settings saved successfully!');
                } else {
                    alert('Error saving settings: ' + data.message);
                }
            });
        }

        function exportData() {
            fetch('/api/get_doses')
            .then(response => response.json())
            .then(data => {
                const exportData = {
                    ...data,
                    export_date: new Date().toISOString(),
                    version: '2.0.0'
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ritalitime_export_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            });
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        // Here you would typically send the data to the server
                        console.log('Import data:', data);
                        alert('Data imported successfully! Please refresh the page to see changes.');
                    } catch (error) {
                        alert('Error parsing import file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
                fetch('/api/clear_all', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({type: 'all'})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('All data cleared successfully!');
                        updateDosesList();
                        updateTimeline();
                    } else {
                        alert('Error clearing data: ' + data.message);
                    }
                });
            }
        }

        // Event listeners for settings
        document.getElementById('profileSelect').addEventListener('change', function() {
            if (this.value) {
                loadProfile(this.value);
            }
        });

        document.getElementById('sleepThreshold').addEventListener('input', function() {
            document.getElementById('sleepThresholdValue').textContent = this.value;
        });

        // Tab functionality and initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Simple tab switching without Bootstrap
            const tabButtons = document.querySelectorAll('button[data-bs-toggle="tab"]');
            const tabContents = document.querySelectorAll('.tab-pane');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetId = this.getAttribute('data-bs-target');
                    
                    // Hide all tab contents
                    tabContents.forEach(content => {
                        content.classList.remove('show', 'active');
                    });
                    
                    // Remove active class from all buttons
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    
                    // Show target content and activate button
                    const targetContent = document.querySelector(targetId);
                    if (targetContent) {
                        targetContent.classList.add('show', 'active');
                        this.classList.add('active');
                        
                        // If settings tab is clicked, load settings
                        if (targetId === '#settings-content') {
                            loadSettings();
                        }
                    }
                });
            });

            // Initial load - now that DOM is ready
            loadSettings();
            updateDosesList();
            updateTimeline();
        });
    </script>
</body>
</html>
